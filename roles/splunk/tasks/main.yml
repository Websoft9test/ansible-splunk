# install splunk by OS_family
- name: Install this role on {{ansible_os_family}}
  include: "{{ansible_os_family}}.yml"

# configure splunk

- name: Create splunk User
  user:
    name: splunk
    shell: /usr/sbin/nologin
    home: /data/splunk
    create_home: no

- name: Create splunk directory
  file:
    path: /data/splunk
    state: directory
    owner: splunk
    group: splunk
    
- name: Download splunk
  get_url:
    dest: /data/splunk
    url: "{{splunk_download_url}}"
    owner: splunk
    group: splunk

#- name: Add startup scripts install.sh to Server
#  template:
#    src: install.sh
#    dest: /data/splunk

- name: Install splunk
  shell: 
    rpm -ivh splunk-8.0.3-a6754d8441bf-linux-2.6-x86_64.rpm

- name: Run expect to set splunk username and password
  shell: |
    set timeout 300
    spawn {{splunk_dir}}/splunk/bin/splunk start --accept-license

    expect "username:"
    send "{{splunk_user}}\n"

    expect "password"
    send "{{splunk_password}}\n"

    expect "password"
    send "{{splunk_password}}\n"
    expect eof
    exit   0
  args:
    executable: /usr/bin/expect
  delegate_to: localhost


- name: Setting splunk service
  template:
    src: splunk.service
    dest: /etc/systemd/system/splunk.service

- name: Enable&restart service
  shell: |
    systemctl daemon-reload
    systemctl enable splunk
    systemctl restart splunk

 

# set soft link, -b cover the exist links
# ln -sb src des
- name: set soft link
  shell: |
    ln -sb /opt/splunk/bin/splunk  /data/splunk/splunk

# check service state
- name: Check splunk Service
  shell: systemctl status splunk | grep Active*
  register: check_splunk_service

  notify: check_splunk_service
